name: Parallel Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch all self-hosted runners
        id: fetch-runners
        run: |
          TOKEN="${{ secrets.PAT }}"
          REPO="${{ github.repository }}"
          API_URL="https://api.github.com/repos/${REPO}/actions/runners"

          echo "Fetching runners for repository: $REPO"
          echo "GitHub API URL: $API_URL"

          RUNNERS=$(curl -s -X GET -H "Authorization: Bearer ${TOKEN}" "${API_URL}")
          echo "Fetched runners information: $RUNNERS"

          RUNNER_LABELS=$(echo "${RUNNERS}" | jq -r '.runners[] | select(.status == "online") | .labels | .[]' | grep '^ip_')
          echo "Runner labels: $RUNNER_LABELS"

          echo "::set-output name=runner_labels::${RUNNER_LABELS}"

      - name: Checkout code
        uses: actions/checkout@v2

      - name: Deploy code on runners
        run: |
          for label in ${{ steps.fetch-runners.outputs.runner_labels }}; do
            echo "Running deployment on runner $label"
            # Example deployment command: git pull origin main
            # Replace the above line with your actual deployment command
          done
